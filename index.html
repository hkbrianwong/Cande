<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Blood Pressure Tracker</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#3498db" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 15px;
    background: #f4f4f4;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
  }
  form {
    background: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  button {
    margin-top: 15px;
    padding: 10px;
    width: 100%;
    border: none;
    background: #3498db;
    color: white;
    font-size: 16px;
    border-radius: 6px;
  }
  button:hover {
    background: #2980b9;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }
  th, td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #ddd;
  }
  canvas {
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    margin-top: 20px;
  }
  .toggle-buttons {
    display: flex;
    justify-content: center;
    margin: 10px 0;
  }
  .toggle-buttons button {
    flex: 1;
    margin: 0 5px;
    background: #2ecc71;
  }
</style>
</head>
<body>

<h1>ü©∫ BP Tracker</h1>

<form id="bpForm">
  <label>Date: <input type="date" id="date" required></label>
  <label>Time: <input type="time" id="time" required></label>
  <label>Systolic: <input type="number" id="systolic" required></label>
  <label>Diastolic: <input type="number" id="diastolic" required></label>
  <label>Pulse: <input type="number" id="pulse" required></label>
  <button type="submit">Add Record</button>
</form>

<h2>üìã Records</h2>
<table id="recordsTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Time</th>
      <th>Systolic</th>
      <th>Diastolic</th>
      <th>Pulse</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="exportCSV()">üì§ Export CSV</button>

<h2>üìä Graph</h2>
<div class="toggle-buttons">
  <button onclick="setRange(7)">Last 7 days</button>
  <button onclick="setRange(30)">Last 30 days</button>
</div>
<canvas id="bpChart" height="300"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const form = document.getElementById('bpForm');
  const tableBody = document.querySelector('#recordsTable tbody');
  const chartCanvas = document.getElementById('bpChart');
  let records = JSON.parse(localStorage.getItem('bpRecords')) || [];
  let chart;
  let chartRange = 7;

  document.getElementById('date').value = new Date().toISOString().split('T')[0];
  document.getElementById('time').value = new Date().toTimeString().slice(0,5);

  function saveRecords() {
    localStorage.setItem('bpRecords', JSON.stringify(records));
  }

  function renderTable() {
    tableBody.innerHTML = '';
    records.forEach((r, index) => {
      const row = `<tr>
        <td>${r.date}</td>
        <td>${r.time}</td>
        <td>${r.systolic}</td>
        <td>${r.diastolic}</td>
        <td>${r.pulse}</td>
        <td><button onclick="deleteRecord(${index})">‚ùå</button></td>
      </tr>`;
      tableBody.innerHTML += row;
    });
  }

  function deleteRecord(index) {
    records.splice(index, 1);
    saveRecords();
    renderTable();
    renderChart();
  }

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    const newRecord = {
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      systolic: document.getElementById('systolic').value,
      diastolic: document.getElementById('diastolic').value,
      pulse: document.getElementById('pulse').value
    };
    records.push(newRecord);
    saveRecords();
    renderTable();
    renderChart();
    form.reset();
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.getElementById('time').value = new Date().toTimeString().slice(0,5);
  });

  function setRange(days) {
    chartRange = days;
    renderChart();
  }

  function renderChart() {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - chartRange);

    const filtered = records.filter(r => new Date(r.date) >= cutoffDate);

    const labels = filtered.map(r => `${r.date} ${r.time}`);
    const systolicData = filtered.map(r => r.systolic);
    const diastolicData = filtered.map(r => r.diastolic);
    const pulseData = filtered.map(r => r.pulse);

    if (chart) chart.destroy();
    chart = new Chart(chartCanvas, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Systolic', data: systolicData, borderColor: 'red', fill: false },
          { label: 'Diastolic', data: diastolicData, borderColor: 'blue', fill: false },
          { label: 'Pulse', data: pulseData, borderColor: 'green', fill: false }
        ]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  function exportCSV() {
    let csv = 'Date,Time,Systolic,Diastolic,Pulse\n';
    records.forEach(r => {
      csv += `${r.date},${r.time},${r.systolic},${r.diastolic},${r.pulse}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'blood_pressure_records.csv';
    a.click();
  }

  renderTable();
  renderChart();

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
  }
</script>
</body>
</html>
