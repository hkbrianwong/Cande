<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form, table, canvas {
            max-width: 100%;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input {
            padding: 5px;
            font-size: 1em;
            width: 100%;
        }
        button {
            margin-top: 10px;
            padding: 8px 12px;
            font-size: 1em;
        }
        table {
            border-collapse: collapse;
            margin-top: 20px;
            width: 100%;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }
        canvas {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1>Blood Pressure Tracker</h1>

<form id="bpForm">
    <label>Systolic:
        <input type="number" id="systolic" inputmode="numeric" pattern="[0-9]*" required>
    </label>
    <label>Diastolic:
        <input type="number" id="diastolic" inputmode="numeric" pattern="[0-9]*" required>
    </label>
    <label>Pulse:
        <input type="number" id="pulse" inputmode="numeric" pattern="[0-9]*" required>
    </label>
    <button type="submit">Add Reading</button>
</form>

<button id="updateChartBtn">Update Chart</button>
<button id="exportCsvBtn">Export CSV</button>

<table id="bpTable">
    <thead>
        <tr>
            <th>Date & Time</th>
            <th>Systolic</th>
            <th>Diastolic</th>
            <th>Pulse</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<canvas id="bpChart" height="200"></canvas>

<script>
    let readings = JSON.parse(localStorage.getItem('bpReadings')) || [];

    const form = document.getElementById('bpForm');
    const tableBody = document.querySelector('#bpTable tbody');
    const ctx = document.getElementById('bpChart').getContext('2d');

    let bpChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Systolic (mmHg)', data: [], borderColor: 'orange', backgroundColor: 'orange', fill: false, tension: 0.3 },
                { label: 'Diastolic (mmHg)', data: [], borderColor: 'gold', backgroundColor: 'gold', fill: false, tension: 0.3 },
                { label: 'Pulse (bpm)', data: [], borderColor: 'lightblue', backgroundColor: 'lightblue', fill: false, tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Blood Pressure Readings' }
            },
            scales: {
                y: { title: { display: true, text: 'Value' }, beginAtZero: false },
                x: { title: { display: true, text: 'Date & Time' } }
            }
        }
    });

    function updateTable() {
        tableBody.innerHTML = '';
        readings.forEach(r => {
            const row = `<tr>
                <td>${r.date}</td>
                <td>${r.systolic}</td>
                <td>${r.diastolic}</td>
                <td>${r.pulse}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    function updateChart() {
        if (readings.length === 0) {
            alert("No data to display in chart.");
            return;
        }
        bpChart.data.labels = readings.map(r => r.date);
        bpChart.data.datasets[0].data = readings.map(r => r.systolic);
        bpChart.data.datasets[1].data = readings.map(r => r.diastolic);
        bpChart.data.datasets[2].data = readings.map(r => r.pulse);
        bpChart.update();
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        const date = new Date().toLocaleString();
        const systolic = parseInt(document.getElementById('systolic').value);
        const diastolic = parseInt(document.getElementById('diastolic').value);
        const pulse = parseInt(document.getElementById('pulse').value);
        readings.push({ date, systolic, diastolic, pulse });
        localStorage.setItem('bpReadings', JSON.stringify(readings));
        form.reset();
        updateTable();
    });

    document.getElementById('updateChartBtn').addEventListener('click', updateChart);

    document.getElementById('exportCsvBtn').addEventListener('click', () => {
        if (readings.length === 0) {
            alert("No data to export.");
            return;
        }
        let csv = "Date & Time,Systolic,Diastolic,Pulse\n";
        readings.forEach(r => {
            csv += `${r.date},${r.systolic},${r.diastolic},${r.pulse}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "bp_readings.csv";
        a.click();
        URL.revokeObjectURL(url);
    });

    // 頁面加載時只更新表格，不畫圖
    updateTable();
</script>

</body>
</html>
