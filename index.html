<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Pressure Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        h1 { text-align: center; }
        input, button { margin: 5px; padding: 8px; font-size: 1em; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #eee; }
        canvas { background: white; margin-top: 20px; }
        .btn-danger { background-color: #ff6666; color: white; }
    </style>
</head>
<body>

<h1>Blood Pressure Tracker</h1>

<!-- Date & Time Inputs -->
<input type="date" id="dateInput">
<input type="time" id="timeInput">

<!-- Number Inputs -->
<input type="number" id="systolic" placeholder="Systolic" inputmode="numeric" pattern="[0-9]*">
<input type="number" id="diastolic" placeholder="Diastolic" inputmode="numeric" pattern="[0-9]*">
<input type="number" id="pulse" placeholder="Pulse" inputmode="numeric" pattern="[0-9]*">

<button id="addBtn">Add Reading</button>
<button id="updateChartBtn">Update Chart</button>
<button id="exportCsvBtn">Export CSV</button>
<button id="clearDataBtn" class="btn-danger">Clear All Data</button>

<table id="bpTable">
    <thead>
        <tr>
            <th>Date & Time</th>
            <th>Systolic</th>
            <th>Diastolic</th>
            <th>Pulse</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<canvas id="bpChart" width="400" height="200"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let readings = JSON.parse(localStorage.getItem('bpReadings')) || [];

    // 預設日期時間
    function setDefaultDateTime() {
        const now = new Date();
        document.getElementById('dateInput').value = now.toISOString().split('T')[0];
        document.getElementById('timeInput').value = now.toTimeString().slice(0,5);
    }
    setDefaultDateTime();

    // Chart 初始化（空）
    const ctx = document.getElementById('bpChart').getContext('2d');
    let bpChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Systolic (mmHg)', data: [], borderColor: 'orange', backgroundColor: 'orange', fill: false, tension: 0.3 },
                { label: 'Diastolic (mmHg)', data: [], borderColor: 'gold', backgroundColor: 'gold', fill: false, tension: 0.3 },
                { label: 'Pulse (bpm)', data: [], borderColor: 'lightblue', backgroundColor: 'lightblue', fill: false, tension: 0.3 }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: {
                y: { title: { display: true, text: 'Value' }, beginAtZero: false },
                x: { title: { display: true, text: 'Date & Time' } }
            }
        }
    });

    function updateTable() {
        const tbody = document.querySelector('#bpTable tbody');
        tbody.innerHTML = '';
        readings.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.datetime}</td><td>${r.systolic}</td><td>${r.diastolic}</td><td>${r.pulse}</td>`;
            tbody.appendChild(tr);
        });
    }

    function updateChart() {
        if (readings.length === 0) return;
        bpChart.data.labels = readings.map(r => r.datetime);
        bpChart.data.datasets[0].data = readings.map(r => r.systolic);
        bpChart.data.datasets[1].data = readings.map(r => r.diastolic);
        bpChart.data.datasets[2].data = readings.map(r => r.pulse);
        bpChart.update();
    }

    document.getElementById('addBtn').addEventListener('click', () => {
        const date = document.getElementById('dateInput').value;
        const time = document.getElementById('timeInput').value;
        const systolic = parseInt(document.getElementById('systolic').value);
        const diastolic = parseInt(document.getElementById('diastolic').value);
        const pulse = parseInt(document.getElementById('pulse').value);

        if (!date || !time || isNaN(systolic) || isNaN(diastolic) || isNaN(pulse)) {
            alert("Please fill all fields correctly.");
            return;
        }

        const datetime = `${date} ${time}`;
        readings.push({ datetime, systolic, diastolic, pulse });
        localStorage.setItem('bpReadings', JSON.stringify(readings));

        updateTable();
        setDefaultDateTime();
        document.getElementById('systolic').value = '';
        document.getElementById('diastolic').value = '';
        document.getElementById('pulse').value = '';
    });

    document.getElementById('updateChartBtn').addEventListener('click', updateChart);

    document.getElementById('exportCsvBtn').addEventListener('click', () => {
        let csv = "Date & Time,Systolic,Diastolic,Pulse\n";
        readings.forEach(r => {
            csv += `${r.datetime},${r.systolic},${r.diastolic},${r.pulse}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'bp_readings.csv';
        a.click();
    });

    document.getElementById('clearDataBtn').addEventListener('click', () => {
        if (confirm("Are you sure you want to delete all stored readings?")) {
            readings = [];
            localStorage.removeItem('bpReadings');
            updateTable();
            bpChart.data.labels = [];
            bpChart.data.datasets.forEach(ds => ds.data = []);
            bpChart.update();
        }
    });

    updateTable(); // 初始化只更新表格，不畫圖
</script>

</body>
</html>
